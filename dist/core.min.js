!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("winston"),require("q"),require("crypto"),require("jsonwebtoken"),require("express"),require("mysql"),require("pg"),require("reflect-metadata")):"function"==typeof define&&define.amd?define("core",["winston","q","crypto","jsonwebtoken","express","mysql","pg","reflect-metadata"],t):"object"==typeof exports?exports.core=t(require("winston"),require("q"),require("crypto"),require("jsonwebtoken"),require("express"),require("mysql"),require("pg"),require("reflect-metadata")):e.core=t(e.winston,e.q,e.crypto,e.jsonwebtoken,e.express,e.mysql,e.pg,e["reflect-metadata"])}(this,function(e,t,n,r,o,i,s,c){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=31)}([function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("q")},function(e,t,n){"use strict";var r=function(){function e(e,t,n){this.errCode=e;var r=this.getMsgByCode(e);this.message=r.message,this.statusCode=r.statusCode,t&&(this.error=t.toString()),n&&(this.message=n)}return e.prototype.getMsgByCode=function(e){var t=new o("Unknown Error",500);return i[e]&&(t=i[e]),t},e}();t.serviceException=r;var o=function(){function e(e,t){void 0===t&&(t=500),this.message=e,this.statusCode=t}return e}();t.exceptionConfig=o;var i={ERR_404:new o("Request not found!",404),ERR_500:new o("Server Error!",500),ERR_nologin:new o("Token Missing!",401),ERR_relogin:new o("Token Timeout!",401),WARNING_authFail:new o("Login FailÔºÅ",400),ERR_401:new o("Permission Denied!",401),ERR_DB:new o("Database failure!",500)}},function(e,t,n){"use strict";var r=n(39),o=n(17),i=n(0),s=n(1),c=n(2),u=n(13),a=function(){function e(){this.router=r.Router()}return e.prototype.getRouter=function(){return this.router},e.prototype.checkAuthentication=function(e,t,n){var r=this,s=e.get("jwt");if(s){var u=global.config;o.verify(s,u.jwtSecKey,function(e,o){e?(i.error(e.message),r.handleError(new c.serviceException("ERR_relogin",e.message),t)):(i.debug("user["+JSON.stringify(o)+"] check token success"),n())})}else i.error("request without token, reject."),this.handleError(new c.serviceException("ERR_nologin"),t)},e.prototype.getAuthentication=function(e){var t=s.defer(),n=e.get("jwt");if(n){var r=global.config;o.verify(n,r.jwtSecKey,function(e,n){e?t.reject(new c.serviceException("ERR_relogin")):(i.debug("user from token:["+JSON.stringify(n)+"]"),t.resolve(n))})}else t.reject(new c.serviceException("ERR_relogin"));return t.promise},e.prototype.getAuthenticationSync=function(e){try{var t=e.get("jwt"),n=global.config;return o.verify(t,n.jwtSecKey)}catch(e){return null}},e.prototype.get=function(e,t,n){void 0===n&&(n=!0),u.apiService.getInstance().push({method:"get",url:e}),n?this.router.get(e,this.checkAuthentication.bind(this),t):this.router.get(e,t)},e.prototype.post=function(e,t,n){void 0===n&&(n=!0),u.apiService.getInstance().push({method:"post",url:e}),n?this.router.post(e,this.checkAuthentication.bind(this),t):this.router.post(e,t)},e.prototype.put=function(e,t){u.apiService.getInstance().push({method:"put",url:e}),this.router.put(e,this.checkAuthentication.bind(this),t)},e.prototype.delete=function(e,t){u.apiService.getInstance().push({method:"delete",url:e}),this.router.delete(e,this.checkAuthentication.bind(this),t)},e.prototype.handleError=function(e,t,n){try{t.status(e.statusCode).jsonp(e),i.error("server error:"+JSON.stringify(e))}catch(n){i.error("unknown server error:"+e.stack),t.status(500).jsonp({errCode:"ERR_500",message:"Server error",statusCode:500,error:"unknown Server error"})}},e}();t.baseController=a},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(0),i=n(7),s=function(e){function t(){var n=e.call(this)||this;if(o.info("init centralizedMySQL"),t._instance)throw new Error("Error: Instantiation failed: Use getInstance() instead of new.");return t._instance=n,n}return r(t,e),t.getInstance=function(){return t._instance},t.prototype.init=function(){var e=global.config;this.pool=this.createPool(e.centralizedDB,"centralized")},t.prototype.getPool=function(e){return o.debug("in database:[centralized]"),this.pool},t}(i.MySQLDB);s._instance=new s,t.centralizedMySQL=s},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(0),i=n(15),s=n(7),c=function(e){function t(){var n=e.call(this)||this;if(n.pools=[],o.info("init distributedMySQL"),t._instance)throw new Error("Error: Instantiation failed: Use getInstance() instead of new.");return t._instance=n,n}return r(t,e),t.getInstance=function(){return t._instance},t.prototype.init=function(){var e=this;global.config.distributedDBs.map(function(t){e.pools.push(e.createPool(t,"distributed"))})},t.prototype.getPool=function(e){if(1===this.pools.length)return this.pools[0];if(!e)throw o.error("Implementation Error: A query to distributed db should always give indicator"),new Error("A query to distributed db should always give indicator");return this.getDBByIndicator(e)},t.prototype.getDBByIndicator=function(e){var t=i.tools.getHash(e);return o.debug("in database:[distributed]["+t+"]"),this.pools[t]},t}(s.MySQLDB);c._instance=new c,t.distributedMySQL=c},function(e,t,n){"use strict";function r(e){return function(t){t.prototype.getTableName=function(){return e.table},t.prototype.getRESTUrl=function(){return e.URL},t.prototype.getDBType=function(){return e.db}}}function o(e){return Reflect.metadata(u,e)}function i(e,t){return Reflect.getMetadata(u,e,t)}function s(e){return Reflect.metadata(a,e)}function c(e,t){return Reflect.getMetadata(a,e,t)}var u=Symbol("exportMetadataKey"),a=Symbol("subQueryMetadataKey");n(42),t.RESTEntity=r,t.exportable=o,t.getExportable=i,t.subQuery=s,t.getSubQuery=c},function(e,t,n){"use strict";var r=n(40),o=n(0),i=n(2),s=function(){function e(){}return e.prototype.createPool=function(e,t){var n=r.createPool({connectionLimit:e.connectionLimit,host:e.host,database:e.database,user:e.user,password:e.password,dateStrings:!0});return o.debug("MySQL database pool("+t+") at:"+e.host+" created."),n},e.prototype.query=function(e,t,n,r,s){o.debug("execute sql:"+e),o.debug("with param:"+JSON.stringify(t)),this.getPool(s).query(e,t,function(s,c){s?(o.error("while execute SQL: "+e),o.error("with params: "+JSON.stringify(t)),o.error(s.toString()),n.reject(new i.serviceException("ERR_DB",s.toString()))):r&&r(c)})},e}();t.MySQLDB=s},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(0),i=n(26),s=function(e){function t(){var n=e.call(this)||this;if(o.info("init centralizedPostgreSQL"),t._instance)throw new Error("Error: Instantiation failed: Use getInstance() instead of new.");return t._instance=n,n}return r(t,e),t.getInstance=function(){return t._instance},t.prototype.init=function(){var e=global.config;this.pool=this.createPool(e.centralizedDB,"centralized")},t.prototype.getPool=function(e){return o.debug("in database:[centralized]"),this.pool},t}(i.PostgreSQLDB);s._instance=new s,t.centralizedPostgreSQL=s},function(e,t,n){"use strict";function r(e){switch(e){case"MySQL":o.centralizedMySQL.getInstance().init(),i.distributedMySQL.getInstance().init();case"PostgreSQL":s.centralizedPostgreSQL.getInstance().init()}}var o=n(4),i=n(5),s=n(8);t.initDB=r;!function(e){e[e.distributed=0]="distributed",e[e.centralized=1]="centralized"}(t.dbType||(t.dbType={}))},function(e,t,n){"use strict";var r=function(){function e(){}return e.prototype.getTableName=function(){throw new Error("table name of this object is not defined!")},e.prototype.getRESTUrl=function(){throw new Error("REST URL of this object is not defined!")},e.prototype.getDBType=function(){throw new Error("dbType of this object is not defined!")},e}();t.baseDomainObject=r},function(e,t,n){"use strict";var r=function(){function e(){this.data=[]}return e}();t.paginationResponse=r},function(e,t,n){"use strict";var r=n(1),o=n(9),i=n(6),s=n(4),c=n(5),u=function(){function e(e){this._domainObject=e,this.centralizedDB=s.centralizedMySQL.getInstance(),this.distributedDB=c.distributedMySQL.getInstance(),this.domainObject=new this._domainObject}return e.prototype.getDomainObject=function(){return this.domainObject},e.prototype.insert=function(e,t){var n=r.defer();return this.getDB(this.domainObject.getDBType()).query("insert into "+this.domainObject.getTableName()+" set ?",e,n,function(e){n.resolve(e.insertId)},t),n.promise},e.prototype.batchInsert=function(e,t){var n=r.defer(),o=this.getDB(this.domainObject.getDBType()),i=Object.keys(e[0]),s=[];return e.forEach(function(e){var t=[];i.map(function(n){t.push(e[n])}),s.push(t)}),o.query("insert into "+this.domainObject.getTableName()+" ("+i.join()+") values ?",[s],n,function(e){n.resolve(e.affectedRows)},t),n.promise},e.prototype.queryByID=function(e,t,n){var o=this;void 0===t&&(t=!0);var i=r.defer();return this.getDB(this.domainObject.getDBType()).query("select * from "+this.domainObject.getTableName()+" where id=?",[e],i,function(e){1!==e.length?i.resolve(null):t?o.postProcess(e[0]).then(i.resolve):i.resolve(e[0])},n),i.promise},e.prototype.listAll=function(e,t){var n=this;void 0===e&&(e=!0);var o=r.defer();return this.getDB(this.domainObject.getDBType()).query("select * from "+this.domainObject.getTableName()+" order by id desc ",[],o,function(t){e?r.all(t.map(n.postProcess.bind(n))).then(function(e){o.resolve(t)}):o.resolve(t)},t),o.promise},e.prototype.update=function(e,t,n){var o=r.defer();return this.getDB(this.domainObject.getDBType()).query("update "+this.domainObject.getTableName()+" set ? where id=?",[this.removeID(e),t],o,function(e){o.resolve(e.affectedRows)},n),o.promise},e.prototype.updateAndRefresh=function(e,t,n){var r=this;return this.update(e,t,n).then(function(){return r.queryByID(t,!0,n)})},e.prototype.delete=function(e,t){var n=r.defer();return this.getDB(this.domainObject.getDBType()).query("delete from "+this.domainObject.getTableName()+" where id=?",[e],n,function(e){n.resolve(e.affectedRows)},t),n.promise},e.prototype.batchDelete=function(e,t){var n=this,o=r.defer(),i=" ",s=!0,c=[];return Object.keys(e).forEach(function(t){s?(i+=" where "+t+n.getConditionKey(e[t]),s=!1):i+=" and "+t+n.getConditionKey(e[t]),Array.prototype.push.apply(c,n.getConditionArg(e[t]))}),this.getDB(this.domainObject.getDBType()).query("delete from "+this.domainObject.getTableName()+i,c,o,function(e){o.resolve(e.affectedRows)},t),o.promise},e.prototype.search=function(e,t){var n=this,o=r.defer(),i=" ",s=!0,c=[];return Object.keys(e).forEach(function(t){s?(i+=" where "+t+n.getConditionKey(e[t]),s=!1):i+=" and "+t+n.getConditionKey(e[t]),Array.prototype.push.apply(c,n.getConditionArg(e[t]))}),this.getDB(this.domainObject.getDBType()).query("select * from "+this.domainObject.getTableName()+i+" order by id desc ",c,o,function(e){r.all(e.map(n.postProcess.bind(n))).then(function(){o.resolve(e)})},t),o.promise},e.prototype.searchLike=function(e,t){var n=this,o=r.defer(),i=" ",s=!0,c=[];return Object.keys(e).forEach(function(t){s?(i+=" where "+t+" like ? ",s=!1):i+=" and "+t+" like ? ",c.push("%"+e[t]+"%")}),this.getDB(this.domainObject.getDBType()).query("select * from "+this.domainObject.getTableName()+i+" order by id desc ",c,o,function(e){r.all(e.map(n.postProcess.bind(n))).then(function(){o.resolve(e)})},t),o.promise},e.prototype.count=function(e){var t=r.defer();return this.getDB(this.domainObject.getDBType()).query("select count(1) as count from "+this.domainObject.getTableName(),[],t,function(e){t.resolve(e[0])},e),t.promise},e.prototype.countAllLike=function(e,t){var n=r.defer(),o=this.getDB(this.domainObject.getDBType()),i=[],s="";if(e.searchAllColumn&&e.searchAllColumn.trim().length>0){s=" where (";for(var c=!0,u=0,a=e.columns;u<a.length;u++){var f=a[u];c?(c=!1,s+=f.name+" like ?"):s+=" or "+f.name+" like ?",i.push("%"+e.searchAllColumn+"%")}s+=") "}return o.query("select count(1) as count from "+this.domainObject.getTableName()+s,i,n,function(e){n.resolve(e[0])},t),n.promise},e.prototype.queryAllLike=function(e,t){var n=this,o=r.defer(),i=this.getDB(this.domainObject.getDBType()),s=[],c="";if(e.searchAllColumn&&e.searchAllColumn.trim().length>0){c=" where (";for(var u=!0,a=0,f=e.columns;a<f.length;a++){var p=f[a];u?(u=!1,c+=p.name+" like ?"):c+=" or "+p.name+" like ?",s.push("%"+e.searchAllColumn+"%")}c+=") "}return s.push(e.start),s.push(e.length),i.query("select * from "+this.domainObject.getTableName()+c+" order by id desc  limit ?,?",s,o,function(e){r.all(e.map(n.postProcess.bind(n))).then(function(){o.resolve(e)})},t),o.promise},e.prototype.queryByCreateDate=function(e,t){var n=r.defer();return this.getDB(this.domainObject.getDBType()).query("select * from "+this.domainObject.getTableName()+" where create_date between ? and ? order by id desc ",[e,t],n,function(e){n.resolve(e)}),n.promise},e.prototype.getDB=function(e){return e===o.dbType.distributed?this.distributedDB:e===o.dbType.centralized?this.centralizedDB:void 0},e.prototype.removeID=function(e){return e.id&&delete e.id,e},e.prototype.postProcess=function(e){return r.all([this.removeNotExportable(e),this.doSubQuery(e)]).then(function(){return e})},e.prototype.doSubQuery=function(e){var t=r.defer(),n=[],o=this;for(var s in e)!function(t){if(i.getSubQuery(o.domainObject,t)){var r=i.getSubQuery(o.domainObject,t);e[t]&&n.push(r.repository.getInstance().queryByID(e[t]).then(function(t){return e[r.name]=t,e}))}}(s);return r.all(n).then(function(){return t.resolve(e)}),t.promise},e.prototype.removeNotExportable=function(e){var t=r.defer();for(var n in e)i.getExportable(this.domainObject,n)===!1&&delete e[n];return t.resolve(e),t.promise},e.prototype.getFields=function(e){var t=[];return Object.getOwnPropertyNames(e).forEach(function(e){t.push(e)}),t},e.prototype.getConditionKey=function(e){if(e.toString().indexOf("{")>=0){var t=" in (",n=!0;return e.substring(e.indexOf("{")+1,e.length-1).split(",").forEach(function(){n?(t+="?",n=!1):t+=",?"}),t+") "}return"=? "},e.prototype.getConditionArg=function(e){if(0==e.toString().indexOf("{")){return e.substring(e.indexOf("{")+1,e.length-1).split(",")}return[e]},e}();t.baseRepository=u},function(e,t,n){"use strict";var r=n(!function(){var e=new Error('Cannot find module "@reactivex/rxjs"');throw e.code="MODULE_NOT_FOUND",e}()),o=n(0),i=function(){function e(){this.apiSteam=new r.Subject;try{o.add(o.transports.File,{filename:"log/log.lo",json:!1,maxsize:4e5,maxFiles:10,level:"debug"}),o.remove(o.transports.Console),o.add(o.transports.Console,{prettyPrint:!0,colorize:!0,silent:!1,timestamp:function(){return(new Date).toLocaleString()},level:"debug"})}catch(e){console.log("a winston init err?"+e)}if(o.info("init api service"),e._instance)throw new Error("Error: Instantiation failed: Use getInstance() instead of new.");e._instance=this,this.apiSteam.subscribe(function(e){o.debug("creating api on URL:{"+e.method+"}     "+e.url)})}return e.getInstance=function(){return e._instance},e.prototype.push=function(e){this.apiSteam.next(e)},e}();i._instance=new i,t.apiService=i},function(e,t,n){"use strict";!function(e){function t(e){e=e.toLowerCase().trim();var t=f.createHash("md5");return t.update(e),t.digest("hex")}function r(e){var t=global.config;return c(l,t.rc4_key,e,t.rc4_iv)}function o(e){var t=global.config;return u(l,t.rc4_key,e,t.rc4_iv)}function i(e,t){var n=global.config;return c(p,e,t,n.aes128_iv)}function s(e,t){var n=global.config;return u(p,e,t,n.aes128_iv)}function c(e,t,n,r){t=a(t),n=a(n);var o=f.createCipheriv(e,t,r),i=o.update(n,"hex","hex");return i+=o.final("hex"),i.toString("hex")}function u(e,t,n,r){t=a(t),n=a(n);var o=f.createDecipheriv(e,t,r),i=o.update(n,"hex","hex");return i+=o.final("hex"),i.toString("hex")}function a(e){return e instanceof Buffer?e:new Buffer(e,"hex")}var f=n(16),p="aes128",l="rc4";e.encryptMd5=t,e.encryptRC4=r,e.decryptRC4=o,e.encryptAES128=i,e.decryptAES128=s}(t.encryption||(t.encryption={}))},function(e,t,n){"use strict";var r=n(16);!function(e){function t(e){for(var t in e)return!1;return!0}function n(e,t){var n=e?e.toString(16):"";if(n.length>2*t)throw new Error("Illegal data length in fillToLength(): "+e+".length > "+t);for(;n.length<2*t;)n="0"+n;return n}function o(e){var t=global.config,n=t.distributedDBs.length,r=e.slice(-1);return isNaN(parseInt(r[0]))?0:r[0]%n}function i(e){var t,n=e.headers,r=n["x-forwarded-for"];return t=r?r:null,t||(t=e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress),t}function s(e,t){var n=!1;return(new Date).getTime()-e.getTime()>6e4*t&&(n=!0),n}function c(e){return u(e,a)}function u(e,t){for(var n="";n.length<e;){var o=void 0;try{o=r.randomBytes(e)}catch(e){continue}for(var i=0;i<o.length;i++){var s=o.readUInt8(i)%t.length;n+=t.charAt(s)}}return n}var a="1234567890";e.isEmptyObject=t,e.fillToLength=n,e.getHash=o,e.getIpAddress=i,e.isErrorCountReset=s,e.generateRandomNumber=c}(t.tools||(t.tools={}))},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=n(3);t.baseController=r.baseController;var o=n(23);t.baseCRUDController=o.baseCRUDController;var i=n(24);t.imageController=i.imageController},function(e,t,n){"use strict";function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}var o=n(9);t.dbType=o.dbType,t.initDB=o.initDB,r(n(25)),r(n(27))},function(e,t,n){"use strict";function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}r(n(6)),r(n(10)),r(n(29)),r(n(11)),r(n(12)),r(n(28)),r(n(30))},function(e,t,n){"use strict";!function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(n(34))},function(e,t,n){"use strict";function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}r(n(15)),r(n(13)),r(n(14))},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(3),i=n(11),s=n(1),c=function(e){function t(t,n){var r=e.call(this)||this;return r._domainObject=t,r._repository=n,r.repository=n.getInstance(),r.initRouters(),r.createCRUD(),r}return r(t,e),t.prototype.createCRUD=function(){var e=this,t=new this._domainObject,n=t.getRESTUrl();this.get(n,function(t,n,r){e.repository.listAll().then(function(e){return n.status(200).jsonp(e)},function(t){return e.handleError(t,n)})}),this.get(n+"/search",function(t,n,r){e.repository.search(t.query).then(function(e){return n.status(200).jsonp(e)},function(t){return e.handleError(t,n)})}),this.get(n+"/search/like",function(t,n,r){e.repository.searchLike(t.query).then(function(e){return n.status(200).jsonp(e)},function(t){return e.handleError(t,n)})}),this.get(n+"/incremental",function(t,n,r){e.repository.queryByCreateDate(t.query.startDate,t.query.endDate).then(function(e){return n.status(200).jsonp(e)},function(t){return e.handleError(t,n)})}),this.get(n+"/:id",function(t,n,r){e.repository.queryByID(t.params.id).then(function(e){e?n.status(200).jsonp(e):n.status(204).jsonp({})},function(t){return e.handleError(t,n)})}),this.post(n,function(t,n,r){Array.isArray(t.body)?e.repository.batchInsert(t.body).then(function(e){return n.status(201).jsonp({affectedRows:e})},function(t){return e.handleError(t,n)}):(t.body.create_date=new Date,e.repository.insert(t.body).then(function(e){return n.status(201).jsonp({id:e})},function(t){return e.handleError(t,n)}))}),this.put(n+"/:id",function(t,n,r){e.repository.update(t.body,t.params.id).then(function(e){return n.status(200).jsonp({affectedRows:e})},function(t){return e.handleError(t,n)})}),this.delete(n+"/:id",function(t,n,r){e.repository.delete(t.params.id).then(function(e){return n.status(200).jsonp({affectedRows:e})},function(t){return e.handleError(t,n)})}),this.post(n+"/pagination",function(t,n,r){var o=t.body,c=new i.paginationResponse;s.all([e.repository.count(),e.repository.countAllLike(o),e.repository.queryAllLike(o)]).spread(function(e,t,r){c.recordsTotal=e.count,c.recordsFiltered=t.count,c.data=r,n.jsonp(c).end()})})},t}(o.baseController);t.baseCRUDController=c},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(!function(){var e=new Error('Cannot find module "multer"');throw e.code="MODULE_NOT_FOUND",e}()),i=n(3),s=function(e){function t(){var t=e.call(this)||this;return t.uploadFolder=global.config.imagePath,t.initRouters(),t}return r(t,e),t.prototype.initRouters=function(){var e=o.diskStorage({destination:this.uploadFolder,filename:function(e,t,n){n(null,t.originalname.split(".")[0]+"."+Date.now()+"."+t.originalname.split(".")[1])}}),t=o({storage:e});this.router.post("/",t.single("imageFile"),function(e,t,n){var r=e.file;r?t.jsonp({success:!0,filename:r.filename}):t.status(400).jsonp({message:"upload failed, file[imageFile] not found in request!"})})},t}(i.baseController);t.imageController=s},function(e,t,n){"use strict";var r=n(4);t.centralizedMySQL=r.centralizedMySQL;var o=n(5);t.distributedMySQL=o.distributedMySQL},function(e,t,n){"use strict";var r=n(41),o=n(0),i=n(2),s=function(){function e(){}return e.prototype.createPool=function(e,t){var n=new r.Pool({max:e.connectionLimit,host:e.host,database:e.database,user:e.user,password:e.password});return o.debug("PostgreSQL database("+t+") at:"+e.host+" pool created."),n},e.prototype.query=function(e,t,n,r,s){o.debug("execute sql:"+e),o.debug("with param:"+JSON.stringify(t)),this.getPool(s).query(e,t,function(s,c){s?(o.error("while execute SQL: "+e),o.error("with params: "+JSON.stringify(t)),o.error(s.toString()),n.reject(new i.serviceException("ERR_DB",s.toString()))):r&&r(c)})},e}();t.PostgreSQLDB=s},function(e,t,n){"use strict";var r=n(8);t.centralizedPostgreSQL=r.centralizedPostgreSQL},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=this&&this.__decorate||function(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=n(10),c=n(6),u=function(e){function t(){return e.apply(this,arguments)||this}return r(t,e),t}(s.baseDomainObject);o([c.exportable(!1),i("design:type",String)],u.prototype,"password",void 0),t.baseUser=u},function(e,t,n){"use strict";var r=function(){function e(){this.searchAllColumn=""}return e}();t.paginationRequest=r;var o=function(){function e(){this.order=""}return e}();t.column=o},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(17),i=n(0),s=n(1),c=n(12),u=n(14),a=function(e){function t(){return e.apply(this,arguments)||this}return r(t,e),t.prototype.update=function(e,t){var n=s.defer(),r=this.getDB(this.domainObject.getDBType());return e.password&&(e.password=u.encryption.encryptMd5(e.password)),r.query("update "+this.domainObject.getTableName()+" set ? where id=?",[this.removeID(e),t],n,function(e){n.resolve(e.affectedRows)}),n.promise},t.prototype.login=function(e,t){var n=this,r=u.encryption.encryptMd5(t),o=s.defer();return this.getDB(this.domainObject.getDBType()).query("select * from "+this.domainObject.getTableName()+" where username=? and password=?",[e,r],o,function(e){1!==e.length?o.resolve(null):n.postProcess(e[0]).then(function(e){o.resolve({id:e.id,token:n.generateJWT(e),detail:e})})}),o.promise},t.prototype.changeNewPassword=function(e,t){var n=s.defer(),r=this.getDB(this.domainObject.getDBType()),o=u.encryption.encryptMd5(e);return r.query("update "+this.domainObject.getTableName()+" set password=? where id=?",[o,t],n,function(e){n.resolve(e.affectedRows)}),n.promise},t.prototype.generateJWT=function(e){i.debug("generate token for user[id:"+e.id+",username:"+e.username+",role:"+e.role+"]");var t=global.config;return o.sign({id:e.id,username:e.username,role:e.role},t.jwtSecKey,{expiresIn:t.jwtTimeout})},t}(c.baseRepository);t.baseUserRepository=a},function(e,t,n){"use strict";function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}r(n(18)),r(n(19)),r(n(20)),r(n(2)),r(n(22)),r(n(21))},function(e,t,n){"use strict";var r=function(){function e(){}return e.getInstance=function(){return e._instance},e.prototype.login=function(e,t,n){return n.login(e,t)},e}();r._instance=new r,t.MySqlAuthenticationService=r},function(e,t,n){"use strict";var r=n(1),o=function(){function e(){}return e.getInstance=function(){return e._instance},e.prototype.login=function(e,t){return r.resolve(null)},e}();o._instance=new o,t.PAMAuthenticationService=o},function(e,t,n){"use strict";var r=n(0),o=n(36),i=n(33),s=n(32),c=n(38),u=n(37),a=n(35),f=function(){function e(){}return e.getInstance=function(){return e._instance},e.prototype.getMessageService=function(e){switch(e){case"jpush":return(new o.JPushMessageService).getInstance();case"wechat":return(new c.WeChatMessageService).getInstance();case"sms":return(new u.SMSMessageService).getInstance();case"email":return(new a.EmailMessageService).getInstance()}},e.prototype.getAuthenticationService=function(){var e=global.config;switch(e.loginType){case"PAM":return r.info("init PAM Authentication Service."),i.PAMAuthenticationService.getInstance();case"MySQL":return r.info("init MySql Authentication Service."),s.MySqlAuthenticationService.getInstance();default:return r.error("invalid login service type["+e.loginType+"]!"),null}},e.prototype.getConfig=function(){return e._config},e.prototype.setConfig=function(t){e._config=t},e}();f._instance=new f,t.serviceFactoryImpl=f},function(e,t,n){"use strict";var r=n(0),o=function(){function e(){}return e.prototype.getInstance=function(){return e._instance},e.prototype.pushMessage=function(e){return r.info("send email."),null},e}();o._instance=new o,t.EmailMessageService=o},function(e,t,n){"use strict";var r=n(0),o=function(){function e(){}return e.prototype.getInstance=function(){return e._instance},e.prototype.pushMessage=function(e){return r.info("push message to App."),null},e}();o._instance=new o,t.JPushMessageService=o},function(e,t,n){"use strict";var r=n(0),o=function(){function e(){}return e.prototype.getInstance=function(){return e._instance},e.prototype.pushMessage=function(e){return r.info("send message to phone."),null},e}();o._instance=new o,t.SMSMessageService=o},function(e,t,n){"use strict";var r=n(0),o=function(){function e(){}return e.prototype.getInstance=function(){return e._instance},e.prototype.pushMessage=function(e){return r.info("push message to Wechat."),null},e}();o._instance=new o,t.WeChatMessageService=o},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mysql")},function(e,t){e.exports=require("pg")},function(e,t){e.exports=require("reflect-metadata")}])});
//# sourceMappingURL=core.min.js.map